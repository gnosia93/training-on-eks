## grafana loki ## 
분산 학습(Distributed Training) 환경에서 각 파드(Pod)가 출력하는 실시간 로그를 추적하고 검색하는 데 Loki는 최적의 솔루션이다 

### 장점 ###
#### 1. 실시간 Raw 텍스트 조회 및 검색 (핵심 기능) ####
* 실시간 스트리밍: 분산 학습 파드가 내뱉는 표준 출력(stdout/stderr)을 Grafana 화면에서 Live 모드로 실시간 모니터링할 수 있습니다.
* 텍스트 검색: 특정 파드 내 로그에서 Error, Loss, Epoch 같은 특정 키워드를 구글 검색하듯 필터링할 수 있습니다.
* 쿼리 예시: {app="dist-training"} |= "Loss" (Loss라는 단어가 포함된 로그만 출력)
* 파드별 개별 조회: 각 파드(rank-0, rank-1 등)마다 레이블이 자동으로 붙기 때문에, 특정 파드의 로그만 따로 떼어서 보거나 여러 파드의 로그를 시계열로 합쳐서 볼 수 있습니다.

#### 2. 분산 학습 시 유용한 기능 ####
* 로그 병합 (Log Aggregation): 여러 노드에 흩어져 있는 파드들의 로그를 시간순으로 정렬하여 하나의 타임라인으로 보여줍니다. 분산 학습 중 특정 Rank에서 발생한 문제가 전체 학습에 어떤 영향을 주었는지 파악하기 쉽습니다.
* Context 조회: 검색 결과에서 특정 에러 로그를 클릭하면, 그 에러 발생 직전과 직후의 로그(Context)를 바로 보여줍니다. 분산 학습 중 데드락이나 통신 오류 원인을 찾을 때 매우 강력합니다.

#### 3. 설정 시 주의사항 (학습 로그 최적화) ####
분산 학습 로그는 양이 많고 한 줄이 길 수 있습니다. 이를 위해 다음 설정을 권장합니다.
* 수집기(Promtail/Fluent Bit) 설정:
  * 파드의 이름을 레이블로 지정하여 pod_name으로 필터링할 수 있게 합니다.
  * 멀티라인 로그(예: 파이썬 Traceback 에러)가 한 줄로 깨지지 않도록 Multi-line stage 설정을 추가합니다.

* Loki 용량 관리:
  * 학습 로그는 한 번에 수십 GB가 쌓일 수 있으므로, 앞서 말씀드린 S3 연동은 필수입니다.

#### 4. Grafana에서의 실제 사용 모습  ####
- Grafana의 Explore 메뉴로 이동합니다.
- Data Source를 Loki로 선택합니다.
- Label browser에서 pod 또는 app 이름을 선택하여 학습 파드를 지정합니다.
- 상단의 Live 버튼을 누르면 학습 중인 로그가 실시간으로 올라오는 것을 볼 수 있습니다.
- 검색창에 필터링할 단어를 입력하여 실시간으로 Raw 텍스트를 분석합니다.

결론적으로, 분산 학습 파드들이 내뱉는 raw 텍스트를 중앙 집중식으로 저장하고, 웹 UI에서 실시간으로 검색하거나 특정 시점의 로그를 복기하는 데 Loki는 가장 현대적이고 가성비 좋은 선택입니다. Grafana 공식 가이드 - LogQL 검색법을 참고하시면 텍스트 검색 쿼리 작성에 도움이 됩니다.


### 전체 데이터 흐름 (3단계) ###
#### 수집 (Collector): ####
* 도구: Fluentd, Fluent Bit, 또는 Promtail (보통 가벼운 Fluent Bit나 Loki 전용인 Promtail을 가장 많이 씁니다).
* 역할: 각 노드(EC2)에서 실행 중인 컨테이너들의 로그 파일(/var/log/pods/...)을 실시간으로 읽어서 Loki 서버로 전송(Push)합니다.

#### 저장 및 인덱싱 (Loki Server): ####
* 도구: Loki
* 역할: 수집기에서 받은 로그를 전달받아 두 가지로 나누어 처리합니다.
  * Chunk (본문): 실제 로그 내용입니다. 이걸 압축해서 S3에 파일 형태로 저장합니다.
  * Index (이정표): 로그를 빨리 찾기 위한 주소록입니다. 2025년 현재는 이 인덱스 정보까지도 S3에 같이 저장하는 방식(TSDB 구조)이 표준입니다.
* 조회 (Grafana):
  * 도구: Grafana
  * 역할: 사용자가 대시보드에서 로그를 검색하면, Grafana가 Loki에게 요청을 보냅니다. Loki는 S3에서 필요한 로그 조각(Chunk)을 가져와서 사용자에게 보여줍니다.



