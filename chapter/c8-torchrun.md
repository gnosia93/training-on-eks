## ν† μΉλ° λ‘λ°λ·° ##
torchrun (PyTorch Elastic) ν™κ²½μ—μ„ ν•λ‚μ λ…Έλ“μ— μ¥μ• κ°€ λ°μƒν•λ©΄, λ‚λ¨Έμ§€ λ…Έλ“λ“¤μ€ λ¬΄ν•μ • κΈ°λ‹¤λ¦¬λ” κ²ƒμ΄ μ•„λ‹λΌ ν„μ¬ μ‘μ—…μ„ μ¤‘λ‹¨ν•κ³  μƒλ΅μ΄ λ‘λ°λ·°(Rendezvous)λ¥Ό ν†µν•΄ μ¬κµ¬μ„±μ„ μ‹λ„ν•©λ‹λ‹¤.
κµ¬μ²΄μ μΈ λ™μ‘ κ³Όμ •μ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

#### 1. μ¥μ•  κ°μ§€ λ° μ „μ†΅ (Stop) ####
ν• λ…Έλ“κ°€ λ‹¤μ΄λκ±°λ‚ ν”„λ΅μ„Έμ¤κ°€ μΆ…λ£λλ©΄, μ—°κ²°λμ–΄ μλ λ‹¤λ¥Έ λ…Έλ“λ“¤μ€ ν†µμ‹  νƒ€μ„μ•„μ›ƒμ„ ν†µν•΄ μ΄λ¥Ό κ°μ§€ν•©λ‹λ‹¤. μ΄ μ‹μ μ—μ„ λ¨λ“  μƒμ΅΄ λ…Έλ“μ ν•™μµ ν”„λ΅μ„Έμ¤λ” μ¦‰μ‹ μ¤‘λ‹¨(Panic/Exit)λ©λ‹λ‹¤.

#### 2. μ¬ν•™μµμ„ μ„ν• μ¬μ§‘κ²° (Rendezvous) ####
torchrunμ€ μ„¤μ •λ min_nodesμ™€ max_nodes λ²”μ„ λ‚΄μ—μ„ λ‹¤μ‹ λ‘λ°λ·°λ¥Ό μ‹λ„ν•©λ‹λ‹¤.
* μƒμ΅΄ λ…Έλ“λ“¤: λ‹¤μ‹ λ‘λ°λ·° ν¬μΈνΈμ— λ¨μ—¬ μƒλ΅μ΄ κµ¬μ„±μ„ κΈ°λ‹¤λ¦½λ‹λ‹¤.
* μ¥μ•  λ…Έλ“: λ§μ•½ μΏ λ²„λ„¤ν‹°μ¤(Kubernetes) κ°™μ€ μ¤μΌ€μ¤νΈλ μ΄ν„°κ°€ λ…Έλ“λ¥Ό λ³µκµ¬μ‹ν‚¨λ‹¤λ©΄, ν•΄λ‹Ή λ…Έλ“λ„ λ‹¤μ‹ λ‘λ°λ·°μ— μ°Έμ—¬ν•©λ‹λ‹¤.
* λ€κΈ° μ‹κ°„: --rdzv_timeout μ„¤μ •κ°’ λ™μ• κΈ°λ‹¤λ¦¬λ©°, min_nodes μ΅°κ±΄μ΄ μ¶©μ΅±λλ©΄ μ¦‰μ‹ λ‹¤μ λ‹¨κ³„λ΅ λ„μ–΄κ°‘λ‹λ‹¤.

#### 3. μ¬μ‹μ‘ (Restart) ####
μƒλ΅μ΄ λ©¤λ²„ κµ¬μ„±μ΄ μ™„λ£λλ©΄(μ: 4κ° λ…Έλ“ μ¤‘ 1κ°κ°€ μ£½μ–΄ 3κ°λ§ λ¨μΈ κ²½μ°), torchrunμ€ λ¨λ“  λ…Έλ“μ ν”„λ΅μ„Έμ¤λ¥Ό μƒλ΅μ΄ RANKμ™€ WORLD_SIZEλ΅ λ‹¤μ‹ μ‹¤ν–‰ν•©λ‹λ‹¤.

#### 4. μ£Όμμ‚¬ν•­: μ²΄ν¬ν¬μΈνΈ λ΅λ“ ####
torchrunμ€ λ…Έλ“ κµ¬μ„±λ§ μλ™μΌλ΅ λ‹¤μ‹ μ΅μ•„μ¤„ λΏ, ν•™μµ λ°μ΄ν„°μ μƒνƒλ¥Ό μλ™μΌλ΅ λ³µκµ¬ν•΄μ£Όμ§€λ” μ•μµλ‹λ‹¤.
μ¥μ•  λ³µκµ¬ ν›„ μ΄μ „ λ‹¨κ³„λ¶€ν„° μ΄μ–΄μ„ ν•™μµν•λ ¤λ©΄, μ½”λ“ λ‚΄μ— torch.saveμ™€ torch.loadλ¥Ό μ΄μ©ν• μ²΄ν¬ν¬μΈνΈ μ €μ¥ λ° λ΅λ“ λ΅μ§μ΄ λ°λ“μ‹ κµ¬ν„λμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤.
λ³΄ν†µ load_state_dictλ¥Ό ν†µν•΄ κ°€μ¥ μµκ·Όμ— μ €μ¥λ λ¨λΈ νμΌλ¶€ν„° λ‹¤μ‹ μ‹μ‘ν•λ„λ΅ μ½”λ“λ¥Ό μ§­λ‹λ‹¤.

#### μ”μ•½ ####
λ…Έλ“ μ¥μ•  μ‹ λ‚λ¨Έμ§€ λ…Έλ“λ“¤μ€ κΈ°λ‹¤λ¦¬κΈ°λ§ ν•λ” κ²ƒμ΄ μ•„λ‹λΌ, λ‹¤ κ°™μ΄ λ©μ·„λ‹¤κ°€ κ°€λ¥ν• λ…Έλ“λ“¤λΌλ¦¬ λ¨μ—¬μ„ μ²μλ¶€ν„°(λλ” λ§μ§€λ§‰ μ²΄ν¬ν¬μΈνΈλ¶€ν„°) λ‹¤μ‹ μ‹μ‘ν•©λ‹λ‹¤.
μ΄κ²ƒμ΄ python -m torch.distributed.launchμ™€ κ°™μ€ κ³Όκ±° λ°©μ‹(μ „μ²΄ μΆ…λ£ ν›„ μλ™ μ¬μ‹μ‘ ν•„μ”)κ³Ό torchrunμ κ°€μ¥ ν° μ°¨μ΄μ μ…λ‹λ‹¤

## μ¬μ‹λ„ ##
torchrunμ—μ„ λ…Έλ“ μ¥μ•  μ‹ μ¬μ‹λ„ νμλ” μ‹¤ν–‰ λ…λ Ή μ‹ μ‚¬μ©ν•λ” --max_restarts μµμ…μΌλ΅ κ²°μ •λ©λ‹λ‹¤. PyTorch Elastic Documentation

#### 1. κΈ°λ³Έ μ¬μ‹λ„ νμ ####
κΈ°λ³Έκ°’: λ³„λ„λ΅ μ„¤μ •ν•μ§€ μ•μΌλ©΄ 0μ…λ‹λ‹¤. μ¦‰, ν• λ²μ΄λΌλ„ λ…Έλ“ μ¥μ• λ‚ ν”„λ΅μ„Έμ¤ μ¤λ¥κ°€ λ°μƒν•λ©΄ μ¬μ‹λ„ μ—†μ΄ μ „μ²΄ μ‘μ—…μ΄ μΆ…λ£λ©λ‹λ‹¤.
μ„¤μ • λ°©λ²•: torchrun --max_restarts=3 ...κ³Ό κ°™μ΄ μ‹¤ν–‰ μ‹ λ…μ‹μ μΌλ΅ νμλ¥Ό μ§€μ •ν•΄μ•Ό ν•©λ‹λ‹¤.

#### 2. λ¬΄ν• μ¬μ‹λ„ μ„¤μ • ####
λ§μ•½ λ…Έλ“ λ³µκµ¬ μ†λ„κ°€ λλ¦¬κ±°λ‚, μΏ λ²„λ„¤ν‹°μ¤ ν™κ²½μ—μ„ λ…Έλ“κ°€ κ³„μ† κµμ²΄λλ” μƒν™©μ΄λΌ λ¬΄ν•ν μ¬μ‹λ„ν•κ³  μ‹¶λ‹¤λ©΄ -1 λλ” λ§¤μ° ν° κ°’μ„ μ„¤μ •ν•  μ μμµλ‹λ‹¤.
μ: torchrun --max_restarts=999 ... (μ‚¬μ‹¤μƒμ λ¬΄ν• μ¬μ‹λ„)

#### 3. μ¬μ‹λ„ λ©”μ»¤λ‹μ¦μ νΉμ§• ####
μΉ΄μ΄νΈ κΈ°μ¤€: --max_restartsλ” μ‘μ—… μ „μ²΄(Job)κ°€ μ‹¤ν¨λ΅ κ°„μ£ΌλκΈ° μ „κΉμ§€ ν—μ©λλ” μ¬κ²°ν•©(Rendezvous) λ° μ¬μ‹μ‘ μ΄ νμλ¥Ό μλ―Έν•©λ‹λ‹¤.
λ¶€λ¶„ λ³µκµ¬: μ„¤μ •λ νμ μ•μ—μ„λΌλ©΄, μΌλ¶€ λ…Έλ“κ°€ μ£½μ–΄λ„ min_nodes μ΅°κ±΄λ§ λ§μ΅±λλ©΄ λ‚¨μ€ λ…Έλ“λ“¤λΌλ¦¬ λ‹¤μ‹ λ‘λ°λ·°ν•μ—¬ ν•™μµμ„ μ΄μ–΄κ°‘λ‹λ‹¤.
νμ μ΄κ³Ό μ‹: λ§μ•½ μ¬μ‹λ„ νμλ¥Ό λ¨λ‘ μ†λ¨ν•λ©΄ torchrunμ€ μµμΆ…μ μΌλ΅ μ‹¤ν¨(Fail) μƒνƒκ°€ λλ©° μΆ…λ£λ©λ‹λ‹¤.


## μ²΄ν¬ν¬μΈνΈ ##
λ¨λ“  λ…Έλ“κ°€ μµμ‹  μ²΄ν¬ν¬μΈνΈ νμΌμ— μ ‘κ·Όν•  μ μμ–΄μ•Ό ν•©λ‹λ‹¤. μ΄λ¥Ό μ„ν•΄ ν„μ—…μ—μ„λ” ν¬κ² λ‘ κ°€μ§€ λ°©λ²•μ„ μ‚¬μ©ν•©λ‹λ‹¤.
#### 1. κ³µμ  μ¤ν† λ¦¬μ§€ μ‚¬μ© (κ°€μ¥ κ¶μ¥λ¨) ####
λ¨λ“  λ…Έλ“κ°€ NFS, AWS FSx, Google Cloud Filestoreμ™€ κ°™μ€ κ³µμ  λ„¤νΈμ›ν¬ μ¤ν† λ¦¬μ§€λ¥Ό λ™μΌν• κ²½λ΅μ— λ§μ΄νΈν•λ” λ°©μ‹μ…λ‹λ‹¤.
* μ¥μ : νΉμ • λ…Έλ“κ°€ μ™„μ „ν μ‚¬λΌμ Έλ„ λ°μ΄ν„°κ°€ μ•μ „ν•λ©°, λ¨λ“  λ…Έλ“κ°€ κ°™μ€ κ²½λ΅(/mnt/nfs/checkpoint.pt)λ¥Ό λ°”λΌλ³΄κΈ°λ§ ν•λ©΄ λ©λ‹λ‹¤.
* λ°©μ‹: 0λ² λ§μ¤ν„° λ…Έλ“κ°€ μ²΄ν¬ν¬μΈνΈλ¥Ό μ €μ¥ν•λ©΄ λ‚λ¨Έμ§€ λ…Έλ“λ“¤μ΄ μ¬μ‹μ‘ μ‹ ν•΄λ‹Ή νμΌμ„ μ½μ–΄μµλ‹λ‹¤.

#### 2. λ΅μ»¬ μ¤ν† λ¦¬μ§€ + λ³µμ  ####
κ° λ…Έλ“μ λ΅μ»¬ λ””μ¤ν¬(SSD)μ— μ €μ¥ν•λ” λ°©μ‹μ…λ‹λ‹¤.
* λ‹¨μ : λ…Έλ“ μμ²΄κ°€ λ¬Όλ¦¬μ μΌλ΅ κ³ μ¥ λ‚λ©΄ ν•΄λ‹Ή λ…Έλ“μ— μλ μ²΄ν¬ν¬μΈνΈλ” μ μ‹¤λ©λ‹λ‹¤.
* λ°©μ‹: μ΄λ¥Ό ν•΄κ²°ν•λ ¤λ©΄ ν•™μµ μ¤‘ μ£ΌκΈ°μ μΌλ΅ μ²΄ν¬ν¬μΈνΈλ¥Ό S3 κ°™μ€ ν΄λΌμ°λ“ μ¤ν† λ¦¬μ§€λ΅ μ—…λ΅λ“ν•κ±°λ‚, λ¨λ“  λ…Έλ“κ°€ κ°μ μκΈ° λ””μ¤ν¬μ— λ™μΌν• λ³µμ‚¬λ³Έμ„ μ €μ¥ν•λ„λ΅ μ„¤κ³„ν•΄μ•Ό ν•©λ‹λ‹¤.

#### π’΅ torchrun μ¬μ‹μ‘ μ‹ μ½”λ“ κµ¬ν„ ν•µμ‹¬ ####
torchrunμ€ ν”„λ΅μ„Έμ¤λ¥Ό λ‹¤μ‹ λ„μ›μ¤„ λΏ, μ²΄ν¬ν¬μΈνΈλ¥Ό λ¶λ¬μ¤λ” μ½”λ“λ” μ§μ ‘ μ‘μ„±ν•΄μ•Ό ν•©λ‹λ‹¤. λ³΄ν†µ λ‹¤μκ³Ό κ°™μ€ λ΅μ§μ„ μ‚¬μ©ν•©λ‹λ‹¤.
```
import torch
import os

def main():
    # 1. μ²΄ν¬ν¬μΈνΈ κ²½λ΅ μ„¤μ • (κ³µμ  μ¤ν† λ¦¬μ§€ κ¶μ¥)
    ckpt_path = "/shared/storage/model_latest.pt"

    # 2. λ§μ•½ κΈ°μ΅΄ μ²΄ν¬ν¬μΈνΈκ°€ μλ‹¤λ©΄ λ΅λ“
    if os.path.exists(ckpt_path):
        checkpoint = torch.load(ckpt_path, map_location='cpu')
        model.load_state_dict(checkpoint['model'])
        optimizer.load_state_dict(checkpoint['optimizer'])
        start_epoch = checkpoint['epoch']
        print(f"Resuming from epoch {start_epoch}")
    
    # 3. ν•™μµ λ£¨ν”„ μ¤‘ μ£ΌκΈ°μ  μ €μ¥ (Rank 0λ²λ§ μ €μ¥)
    if dist.get_rank() == 0:
        torch.save({...}, ckpt_path)
```
* κ³µμ  μ €μ¥μ†(NFS λ“±)λ¥Ό μ“°λ” κ²ƒμ΄ κ°€μ¥ μ•μ „ν•κ³  νΈλ¦¬ν•©λ‹λ‹¤. 
* λ…Έλ“κ°€ μ¬μ‹μ‘λ  λ• μλ™μΌλ΅ ckpt_pathλ¥Ό ν™•μΈν•μ—¬ load_state_dictλ¥Ό μν–‰ν•λ” λ΅μ§μ΄ μ½”λ“μ— ν¬ν•¨λμ–΄μ•Ό ν•©λ‹λ‹¤.
* λ§μ•½ κ³µμ  μ €μ¥μ†κ°€ μ—†λ‹¤λ©΄, λ…Έλ“ μ¥μ•  μ‹ ν•΄λ‹Ή λ…Έλ“μ— μλ λ°μ΄ν„°λ” λ» μ“°κ² λλ―€λ΅ μ™Έλ¶€ ν΄λΌμ°λ“ μ €μ¥μ†(S3 λ“±)μ— λ°±μ—…ν•λ” μ μ°¨κ°€ ν•„μ”ν•©λ‹λ‹¤.

## μ¥μ•  λ³µκµ¬ μ‹λ‚λ¦¬μ¤ (Kubernetes + PyTorchJob) ##
* μ¥μ•  λ°μƒ: ν• κ°μ μ›μ»¤ ν¬λ“κ°€ λ…Έλ“ λ¬Έμ λ΅ μΆ…λ£λ©λ‹λ‹¤.
* λ‘λ°λ·° μ¤‘λ‹¨: λ‚λ¨Έμ§€ λ…Έλ“λ“¤μ torchrun ν”„λ΅μ„Έμ¤κ°€ μ¥μ• λ¥Ό κ°μ§€ν•κ³  μ¤‘λ‹¨λ©λ‹λ‹¤.
* ν¬λ“ μ¬μƒμ„±: PyTorchJob μ»¨νΈλ΅¤λ¬κ°€ μ£½μ€ ν¬λ“λ¥Ό ν™•μΈν•κ³  μƒλ΅μ΄ ν¬λ“λ¥Ό λ„μ›λ‹λ‹¤.
* μ¬κ²°ν•©(Rendezvous): λ¨λ“  ν¬λ“(μ‹ κ· ν¬λ“ ν¬ν•¨)κ°€ λ‹¤μ‹ λ‘λ°λ·° ν¬μΈνΈμ— λ¨μ—¬ WORLD_SIZEλ¥Ό ν™•μΈν•©λ‹λ‹¤.
* ν•™μµ μ¬κ°: μ½”λ“κ°€ λ§μ§€λ§‰ μ²΄ν¬ν¬μΈνΈλ¥Ό λ΅λ“ν•μ—¬ ν•™μµμ„ μ΄μ–΄κ°‘λ‹λ‹¤. (κ³µμ  μ¤ν† λ¦¬μ§€ ν•„μ)

```
apiVersion: "kubeflow.org/v1"
kind: "PyTorchJob"
metadata:
  name: "elastic-train"
spec:
  pytorchReplicaSpecs:
    Worker:
      replicas: 4  # μ „μ²΄ λ…Έλ“ μ
  elasticPolicy:
    minReplicas: 4 # min/maxλ¥Ό λ™μΌν•κ² μ„¤μ •ν•μ—¬ κ³ μ • κ·λ¨ μ μ§€
    maxReplicas: 4
    rdzvBackend: c10d # Kubernetes λ‚΄λ¶€ μ„λΉ„μ¤ μ΄λ¦„μ„ rdzvEndpointλ΅ μ‚¬μ©
    maxRestarts: 3
```

